import{a as I,S as _}from"./@wry-089e8e94.js";const L=()=>Object.create(null),{forEach:U,slice:Z}=Array.prototype,{hasOwnProperty:$}=Object.prototype;class m{constructor(t=!0,s=L){this.weakness=t,this.makeData=s}lookup(...t){return this.lookupArray(t)}lookupArray(t){let s=this;return U.call(t,n=>s=s.getChildTrie(n)),$.call(s,"data")?s.data:s.data=this.makeData(Z.call(t))}peek(...t){return this.peekArray(t)}peekArray(t){let s=this;for(let n=0,r=t.length;s&&n<r;++n){const c=this.weakness&&S(t[n])?s.weak:s.strong;s=c&&c.get(t[n])}return s&&s.data}getChildTrie(t){const s=this.weakness&&S(t)?this.weak||(this.weak=new WeakMap):this.strong||(this.strong=new Map);let n=s.get(t);return n||s.set(t,n=new m(this.weakness,this.makeData)),n}}function S(e){switch(typeof e){case"object":if(e===null)break;case"function":return!0}return!1}const y=new I,{hasOwnProperty:q}=Object.prototype,v=Array.from||function(e){const t=[];return e.forEach(s=>t.push(s)),t};function g(e){const{unsubscribe:t}=e;typeof t=="function"&&(e.unsubscribe=void 0,t())}const p=[],x=100;function h(e,t){if(!e)throw new Error(t||"assertion failure")}function O(e,t){const s=e.length;return s>0&&s===t.length&&e[s-1]===t[s-1]}function j(e){switch(e.length){case 0:throw new Error("unknown value");case 1:return e[0];case 2:throw e[1]}}function z(e){return e.slice(0)}class w{constructor(t){this.fn=t,this.parents=new Set,this.childValues=new Map,this.dirtyChildren=null,this.dirty=!0,this.recomputing=!1,this.value=[],this.deps=null,++w.count}peek(){if(this.value.length===1&&!f(this))return k(this),this.value[0]}recompute(t){return h(!this.recomputing,"already recomputing"),k(this),f(this)?F(this,t):j(this.value)}setDirty(){this.dirty||(this.dirty=!0,P(this),g(this))}dispose(){this.setDirty(),R(this),C(this,(t,s)=>{t.setDirty(),W(t,this)})}forget(){this.dispose()}dependOn(t){t.add(this),this.deps||(this.deps=p.pop()||new Set),this.deps.add(t)}forgetDeps(){this.deps&&(v(this.deps).forEach(t=>t.delete(this)),this.deps.clear(),p.push(this.deps),this.deps=null)}}w.count=0;function k(e){const t=y.getValue();if(t)return e.parents.add(t),t.childValues.has(e)||t.childValues.set(e,[]),f(e)?A(t,e):K(t,e),t}function F(e,t){return R(e),y.withValue(e,H,[e,t]),Q(e,t)&&J(e),j(e.value)}function H(e,t){e.recomputing=!0;const{normalizeResult:s}=e;let n;s&&e.value.length===1&&(n=z(e.value)),e.value.length=0;try{if(e.value[0]=e.fn.apply(null,t),s&&n&&!O(n,e.value))try{e.value[0]=s(e.value[0],n[0])}catch{}}catch(r){e.value[1]=r}e.recomputing=!1}function f(e){return e.dirty||!!(e.dirtyChildren&&e.dirtyChildren.size)}function J(e){e.dirty=!1,!f(e)&&M(e)}function P(e){C(e,A)}function M(e){C(e,K)}function C(e,t){const s=e.parents.size;if(s){const n=v(e.parents);for(let r=0;r<s;++r)t(n[r],e)}}function A(e,t){h(e.childValues.has(t)),h(f(t));const s=!f(e);if(!e.dirtyChildren)e.dirtyChildren=p.pop()||new Set;else if(e.dirtyChildren.has(t))return;e.dirtyChildren.add(t),s&&P(e)}function K(e,t){h(e.childValues.has(t)),h(!f(t));const s=e.childValues.get(t);s.length===0?e.childValues.set(t,z(t.value)):O(s,t.value)||e.setDirty(),T(e,t),!f(e)&&M(e)}function T(e,t){const s=e.dirtyChildren;s&&(s.delete(t),s.size===0&&(p.length<x&&p.push(s),e.dirtyChildren=null))}function R(e){e.childValues.size>0&&e.childValues.forEach((t,s)=>{W(e,s)}),e.forgetDeps(),h(e.dirtyChildren===null)}function W(e,t){t.parents.delete(e),e.childValues.delete(t),T(e,t)}function Q(e,t){if(typeof e.subscribe=="function")try{g(e),e.unsubscribe=e.subscribe.apply(null,t)}catch{return e.setDirty(),!1}return!0}const X={setDirty:!0,dispose:!0,forget:!0};function ee(e){const t=new Map,s=e&&e.subscribe;function n(r){const c=y.getValue();if(c){let o=t.get(r);o||t.set(r,o=new Set),c.dependOn(o),typeof s=="function"&&(g(o),o.unsubscribe=s(r))}}return n.dirty=function(c,o){const u=t.get(c);if(u){const l=o&&q.call(X,o)?o:"setDirty";v(u).forEach(d=>d[l]()),t.delete(c),g(u)}},n}let E;function Y(...e){return(E||(E=new m(typeof WeakMap=="function"))).lookupArray(e)}const b=new Set;function te(e,{max:t=Math.pow(2,16),keyArgs:s,makeCacheKey:n=Y,normalizeResult:r,subscribe:c,cache:o=_}=Object.create(null)){const u=typeof o=="function"?new o(t,i=>i.dispose()):o,l=function(){const i=n.apply(null,s?s.apply(null,arguments):arguments);if(i===void 0)return e.apply(null,arguments);let a=u.get(i);a||(u.set(i,a=new w(e)),a.normalizeResult=r,a.subscribe=c,a.forget=()=>u.delete(i));const B=a.recompute(Array.prototype.slice.call(arguments));return u.set(i,a),b.add(u),y.hasValue()||(b.forEach(G=>G.clean()),b.clear()),B};Object.defineProperty(l,"size",{get:()=>u.size,configurable:!1,enumerable:!1}),Object.freeze(l.options={max:t,keyArgs:s,makeCacheKey:n,normalizeResult:r,subscribe:c,cache:u});function d(i){const a=i&&u.get(i);a&&a.setDirty()}l.dirtyKey=d,l.dirty=function(){d(n.apply(null,arguments))};function D(i){const a=i&&u.get(i);if(a)return a.peek()}l.peekKey=D,l.peek=function(){return D(n.apply(null,arguments))};function V(i){return i?u.delete(i):!1}return l.forgetKey=V,l.forget=function(){return V(n.apply(null,arguments))},l.makeCacheKey=n,l.getKey=s?function(){return n.apply(null,s.apply(null,arguments))}:n,Object.freeze(l)}export{ee as d,te as w};
